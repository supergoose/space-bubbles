<!DOCTYPE html>
<!-- HTML5 Hello world by kirupa - http://www.kirupa.com/html5/getting_your_feet_wet_html5_pg1.htm -->
<html lang="en-us">

<head>
<meta charset="utf-8">
<title>Space Bubbles</title>

<script src="pixi.js"></script>
<script src="keyboard.js"></script>
<script src="Spaceship.js"></script>
<script src="Bullet.js"></script>
<script src="Asteroid.js"></script>
<script src="Explosion.js"></script>
<script src="ObjectPool.js"></script>

<style type="text/css">
canvas{
    margin:0 auto;
}
</style>


</head>

<body>

<script> 

/* global PIXI, keyboard, Spaceship, Bullet, Asteroid, ObjectPool, Collision */
//https://github.com/kittykatattack/learningPixi#renderer

//Set PIXI aliases
var Container = PIXI.Container;
var Renderer = PIXI.autoDetectRenderer;
var Loader = PIXI.loader;
var Resources = PIXI.loader.resources;
var Sprite = PIXI.Sprite;
var Rectangle = PIXI.Rectangle;

//Create rendering equipment
var renderer = new Renderer(800,600);
var stage = new Container(0x000000);
var state = play;

var Mouse = renderer.plugins.interaction.mouse.global;

var time;

var w = keyboard(87);
var s = keyboard(83);
var a = keyboard(65);
var d = keyboard(68);
var space = keyboard(32);

document.body.appendChild(renderer.view);

renderer.render(stage);
renderer.view.style.position = "absolute";
renderer.view.style.display = "block";
renderer.autoResize = true;
renderer.resize(window.innerWidth-20, window.innerHeight-30);

//Start loading assets
Loader
.add("Ship", "img/spaceship.png")
.add("Bullet", "img/bullet.png")
.add("Asteroid-1", "img/asteroid.png")
.add("Explosion", "img/explosion-2.png")
.load(setup);

var player;
var playerBullets = null;
var explosions = null;
var asteroids = null;// new Asteroid();
//var bullet = null;

var t;
    
function setup()
{
    /*global Ticker */
    t = new PIXI.ticker.Ticker();
    
    player = new Spaceship(100, 100, Resources["Ship"].texture);
    
    playerBullets = new ObjectPool(Bullet, Resources["Bullet"].texture, 50);
    
    
    player.setBullets(playerBullets);
    
    player.setForward(w);
    player.setBrake(s);
    player.setFollow(Mouse);
    player.setTicker(t);
    
    // create an array of textures from an image path
    var explosionFrames = [];

    for (var i = 0; i < 10; i++) 
    {
        var rect = new Rectangle(i*32, 0, 32, 32);
        explosionFrames[i] = Resources["Explosion"].texture.clone();//.frame = rect;
        explosionFrames[i].frame = rect;
        
    }

    /* global Explosion */
    explosions = new ObjectPool(Explosion, explosionFrames, 20);
    stage.addChild(explosions);
    
    stage.addChild(player);
    
    asteroids = new ObjectPool(Asteroid, Resources["Asteroid-1"].texture, 50);
    stage.addChild(asteroids);

    stage.addChild(playerBullets);

    Mouse.down = false;
    document.addEventListener("mousedown", function(evt){
        Mouse.down = true;
    });
    
    document.addEventListener("mouseup", function(evt){
        Mouse.down = false;
    });
    
    
    
    gameloop();
}

function gameloop()
{
    requestAnimationFrame(gameloop);
    renderer.render(stage);
    
    state(t.elapsedMS);
}

function play(dt)
{
    checkCollisions();
}

function checkCollisions()
{
    var a = asteroids.getVisibleChildren();
    for(var j = 0; j < a.length; j++)
    {
        var asteroid = a[j];
        var visiBullets = playerBullets.getVisibleChildren();
        
        for(var i =0; i < visiBullets.length; i++)
    	{
    	    var bullet = visiBullets[i];
    	  
    	    if(Collision.circular(bullet, asteroid, 32))
    	    {
    	        //create explosion sprite
    	        var expl = explosions.getInvisibleChild();
    	        expl.x = asteroid.x;
    	        expl.y = asteroid.y;
    	        expl.visible = true;
    	        expl.gotoAndPlay(0);
    	        
    	        bullet.collided(asteroid);
    	        asteroid.collided(bullet);
    	    }
    	    
    	}
    }
    
    
}


var Collision = {
    circular: function(a,b,r)
    {
        var difx = a.x - b.x;
    	    var dify = a.y - b.y;
    	    var dif = Math.sqrt((difx*difx+dify*dify));
    	    
    	    return (dif < r);
    }
}


</script>

</body>
</html>
